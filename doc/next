Now what _ you wanted to create the user interface code
Get config from administrator
Implement a rangeSlider

Implement alarm messages
Implement range messages
Implement stale messages

inp
out
hum
upper
lower
high
low
   
status
  enabled
  disabled
  upper lower
  high low

upon receipt of new data or setpoint - upper, lower, high, low
  check for status change
  if change send out a message

every minute - run through every metric
  for each process
    for each metric
      check for staleness
        send out message if stale
      

      
stale - inp, out, hum - does not apply to -- upper lower high low
  ok
  late   1 minutes old - inp
  stale  2 minutes old - inp
stale
    
  






What to do right now. 
Demo this for Slobodan today
Upload to labtime.org
Modify
Get the oxy page working - now 

Create a test environment
   different mqtt broker - ip address.
   Same Grafana server
   
   



What next?
  Get the MQTT page working again
  Get the oxy and cb pages working - fuck SAFIRE

Look into MQTT jobs
Rewire in the furnace
Rewire the counter light
  




So what to do?
I want the MQTT Monitor to
  Show just one projects client
  Show all projects clients
  This page subscribes to everything
  The MQTT monitor page doesn't need to know specifics about the clients and their inputs/outputs
  I'm going to want a page that shows all projects

The MQTT page doesn't need to know anything specific about the metrics
It does need to know a little about the clients
   client name
   description

administrator
  Does the administrator client need to expand the clients?
    each client needs to know their project
  At this time it doesn't care about expanding metrics - in the future it might

What to do?
  Disable the client expansion for now
  That or make a very short expansion
  Make a new request - :w
:w

  
  On some pages we want the description, but the values are ok
  



Move the MQTT stuff out of index into its own file
MqttManager

Properties -
   Host
   Username
   Password
   PageId

Create a page which states - Connecting to MQTT
   MqttManager - connectCB - Once the connection is established 
     MqttManager - getConfig - Request page configuration
       Requesting page configuration
      Once the configuration has arrived - build the page 






Make each page start the MQTT server.

Either read in a file for each page,
or pass them as properties
I like the file idea better.

Take the MQTT stuff out of the index file.

Add the MQTT data to the global arguments
Load the file, then connect
First create the file




Get the UI working - Search for 



Get the code working on ESP32 to read one-wire temperature.
   start administrator on saphira with new config
   start arduino





administrator
  Upon receipt of input values 
    save values - metricId, ProjectId, valueId
    valueId - value, upper, lower, high, low
    set value state 
      Upon changine state, 
         send a message - topic: PROJECTID/msg/all
      states
         Ok
         High/Low - out of range 
         Upper/Lower Alarm

  Every 10 seconds cycle through each metric
    Check the value, if it's old then set stale state
       Initially set stalePeriod to the value in config - if not found set to 1 minute
       0 - value is ok       grey
       1 - 1x stalePeriod    green      
       2 - 2x stalePeriod    blue
       4 - 4x stalePeriod    purple
       8 - 8x stalePeriod    red

  Each metric save in administrator has
       value upper lower high low stale state
       each of the above stores a record with
          value
          date
          source?
          
       
 

hmi
   Upon receipt of a state change message,
      ValueStateChange - Update the color of the metric
         orange  High/Low
         red     Upper/lower alarm
      StaleStateChange
         5 states as defined above
      
   Create slider to change High/Low and Upper/Lower alarms
      Send message to administrator to change value in 
   
         
          
    When building a clients configuration
      Add values, state, etc.
*Get the fucking hmi working again
*  Issues
*    Client filters don't use localStorage
*    MqttPanel doesn't update 
*      Do I have an error I'm not seeing?

*Finish Oxy
  administrator history
    save history
    set values to history or default
    Use this history when creating sliders, metrics, buttons

  Get the MQTT monitor working correctly

  arduino code
    Get my ethernet connection working
    Put an create a simulation function?
    Plot it on grafana - oxy

    
  Contact Slobodan and Edo

What's next?


Finish install of Oxy.
Get labtime working - 
  start telegraf sessions first


Install and get running for Oxy


Save notes and chat into grafana
   Why wasn't telegraf getting my messages
  *Add Enter key to msgPane
   am

Update slider on human event on another slider



Install labtime on atlas2
   labtime software 
   npm
   node
   mosquitto
   

Get telegraf install onto atlas2
Gat



Getting the SAFIRE lab page near completion
  Save Msgs into Influx
    It doesn't appear to be getting any messages.
      Nothing shows up
      No messages
      log file?


Hold off on the simulator.
Instead focus on the UI slider
  For now create one for pressure and put it on the SAFIRE page
  a bunch of them for testing

  Create an alarm for pressure and temperature

  Use slider to fake the pressures and temperature

  Internal     Ch_Internal_K_C    Another slide to set alarms
  External     Ch_External_K_C
  Ambient      Ch_Ambient_K_C
  Pressure     Ch_NA_Human_PSI
  AC Voltage   PS_NA_Pico_V
  AC Current   PS_NA_Pico_A

  Slider with upper and lower values

  Text entry field


 
   



UI
  Create SAFIRE Lab Experiment Panel 
    Sensors
      Pressure
      Temperature C
      AC Voltage/Current
    Messages
      Chat
      Notes
      Notifications
    MQTT Activity - I like this on a separate page
  
    
    
  Create Inputs to simulate human or sensor input
    Slider
    On/Off
    Text
    
Administrator
   Monitor all Source types
      I Edge Input - thermocouples, voltages
      O Output - control
      H Human Input, O, H, A
      A Alarm on/off
   Keep track of values for each - project instance metric type 

   GetValue
   SetValue
   Upon receipt of IOHA
      if new value is out of alarm
        if alarm == false
           Post alarm OFF message to mqtt
           Set alarm true
      else if new value is ok
        If alarm == true
          Post alarm ON message to mqtt
          Set Alarm false
      
    




Get labtime working at the lab.
  Get atlas2 configured 1 hr


So what now?  Jesus its late.
Wait for Ben, work on telegraf

Work on telegraf loaders for Michael
Get telegraf and the historian working at the Complex.
  Install a debian computer
  Install Mosquitto
  Install Influx
    create database s1
  Install Grafana
  Install my telegraf 
    git a copy







Architecture
   What is MQTT?
   System Diagram
   Topics and Payloads
   Metrics
Clients   
   MQTT Monitor
   Administrator
   Controller
   LabTime UI
   Edge Devices
   Drupal CMS
   Telegraf data loaders
Drupal
   Entities
   OrganizationExperiments
   
Historian
   Telegraf
   InfluxDB
   Grafana dashboards
Glossary of Terms
   


Create a document - glossar



So what next?  Let's do something cool.
Save the activities in Drupal.





What should I do today - work on drupal client
Start with entities again?
Get it working first with the content types


Fix nodejs clients so they don't get multiple ???? subscriptions?



Entities




Create a realistic :q`

Component Gm  GeigerMeister
Position  1-6 Level
Device    N2  Node 2-13
Composition (optional)  - N2, xray, IR, etc.
Units     CPS Counts per second

Create the activity entity - you have what you need.:
activity entity - watch the videos.



Drupal - get a node
So what now?
Work on loading data into Drupal
Create the activity entity
Load messages and activities into Drupal
Display those messages on the instance page.

Query Drupal for the currently active instances for a organization
Can have more than one instance per project.
A project is a piece of hardware in an experiment.  :q



Documentation
Drupal code -
Video panel
Benefits



So what next?  I don't know.  
Work on DRupal.
Do some documentation
   Finish Metrics
   Work on Topics

Arduino
  Download FreeMemory
  Look at all the major uses and consolidate them.
    Can I optimize how the configuration is saved
    Can I save the configuration in Flash - then when it shuts off it remembers. 


Change topic to include INSTANCE
Where does instance come from?

Drupal - instigator knows the instance

User logs in with LabTime
Find out what instances are running
Needs to come from the Drupal program

For now just do instance 42

There will be one controller per instance

An instance is one
   LabTime - Reactor, Apparatus, Chamber
   Upstream - Department, Group
   Finance - Team, Individual

How does an Arduino know it processId and Instance
In Drupal users selects projectId and instance for that project

A location can run one instance at a time
Multiple instance 

             Project             Instance     Domain/Arena/Realm
LabTime      Experiment          Run          Reactor
Upstream     Meeting/Production  Event        Department/Unit
Finance      Company/Unit        Game         Team

Potential names for Instigator
   Domain
   Arena
   Realm 

Reactor 1 is running a project and an instance
Reactor 2 is running a project and a different instance
Reactor 3 is running a project and a different instance

When I start a controller it needs to know the project id and instance
   query drupal with the instigator - Reactor 1


  


Get Drupal working
projects
new entities - 
  activities, 
    start time
    end time - optional
    type - TID - activity types?
    msg
  messages
    time
    type - chat, question, poll, notes
    msg


MQTT Drupal client
  Retrieve a node by NID
  List current or active projects - where does it get this?
  Find the 2-3 character id for a project
  Save activities and messages

Show the status gets sent to the children
Manage the status array, on request just ship it
Initially initialize it in administrator
Arduino
   Make arduino code use status for some fields
      enabled
      debugLevel
      clientId
      mqttClientId
      mqttConnected
   Send rsp to all requests
Labtime
 * get enabled button working
   set buttons according to the current status
 - update buttons according to changes in status
   mqttRegisterTopicCB - (topic, {rsp: ??, cmd: ??)
Administrator
 * After connecting unsubscribe from everything
   Add mqtt connected
   Initialize status for clients
      enabled
      debug level
      sample rate
                                 




What now?
On boot, have the administrator request the status for each client
Have the administrator store the status for each client
Save the status separater from the config - that or copy the config




arduino - create a subscribe function that resubscribes any time the client connects and reconnects

rio1 - connect an out put to an input - first read the voltage, then output a voltage and see the changes 
- need to have a project running -

all  mqttAdminAllSub        a/cmd/all
cmd  mqttAdminCmdSub        a/cmd/IP    ->    a/cmd/CLIENTID
rsp  mqttAdminRspSub        a/rsp/IP    ->    a/rsp/CLIENTID
out  mqttOutputSub          rf/out/CLIENTID

cmd  mqttAdminCmdPub[topicSize]; a/cmd/administrator  // publish command to administrator
rsp  mqttAdminRspPub[topicSize]; a/rsp/CLIENTID       // publish responses to administrator commands
inp  mqttInputPub[topicSize];    a/cmd/administrator
cod  mqttCodPub[topicSize];      rf/inp/CLIENTID
msg  mqttMsgPub[topicSize]       rf/msg/CLIENTID

==========================


RegisterMetric CB - The type is embedded in the Influx string
Use the metric and the type - every time
Also use the projectId
Register for a projectId, sourceId, metricId - 

*Change the name source to sourceId




What now?

Get chat working - do I have the software here to do it?
Yes, I do




The rack is replaced - It makes a little too much noise - I hope it calms down.
The turn signal is drying out - can I order new ones?
So what next?   What can I work on.
It's 9:51/  Check to see if I have my bushings.
Install the new rack and pinion today?
That or what? 

Might as well, it would be a change of pace for sure.






What next?  Let's do something cool
Make the image overlay work.  Read in the file,
cycle through it.


Get chat working
   Use msg stuff created earlier
Each panel needs padding
   
Make an MqttClient - how? 


Today - work on the experiment page

  Experiment page
    Cabin image of all temperature sensors
    Chat window
    Control block
      Slider sends information to the controller
      Controller slowly changes output in increments of 1 
      Display three things - human, output, input


MQTT monitor
   Break this off as a separate program

HMI
  When changing pages -
    - subscribe and unsubscribe from topics to minimize mqtt load
    - unregister and reregister all topics

Arduino
 *Reset works
 *Input works
 *Get status working from arduino
 *Start sending mqtt cod messages from arduino
 *Try Mqtt connect multiple times 
     10 times - wait 25 milliseconds - try again = total of 250 milliseconds
  Get output working on the arduino
  Wire an arduino to connect an output back to an input
    Output a voltage and measure the input

